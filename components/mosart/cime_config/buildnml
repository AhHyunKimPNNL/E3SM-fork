#!/usr/bin/env python3

"""
Namelist creator for E3SM's MOSART component
"""

import os, sys

_CIMEROOT = os.path.join(os.path.dirname(os.path.abspath(__file__)), "..","..","..","cime")
sys.path.append(os.path.join(_CIMEROOT, "scripts", "Tools"))

from standard_script_setup import *
from CIME.case import Case
from CIME.utils import expect, run_cmd_no_fail, safe_copy
from CIME.buildnml import create_namelist_infile, parse_input

logger = logging.getLogger(__name__)

def get_namelist_defaults(srcroot):
    """
    Function returns a list of acceptable namelist options from 
    namelist_defaults_mosart.xml
    """
    import xml.etree.ElementTree as ET
    
    nml_defaults_xml = srcroot + '/components/mosart/bld/namelist_files/namelist_defaults_mosart.xml'
    defaults_list = [] 
    ifile = open(nml_defaults_xml,'r')
    lines = ifile.read() 
    root = ET.fromstring(lines) 
    for child in root:
        defaults_list.append(child.tag.lower())

    return defaults_list

def parse_use_case(use_case,nmldefaults): 
    """
    Function takes in the MOSART_NML_USE_CASE option
    and parses the associated XML file.  
    Returns infile with adjusted namelist options which are 
    then set in the mosart_in file in the case run directory.
    """
    import xml.etree.ElementTree as ET
    print (f"Parsing XML File {use_case}")
    try:
        ifile = open(use_case,'r')
    except FileNotFoundError:
        print(f"Provided use case file {use_case} Does Not Exist")
        sys.exit()
    
    infile = ""
    lines = ifile.read() 
    root = ET.fromstring(lines) 
    for child in root:
        if(child.tag in nmldefaults):
            infile += f"{child.tag} = {child.text} \n"
    return infile  

###############################################################################
def buildnml(case, caseroot, compname):
###############################################################################
    expect(compname == "mosart", compname)

    os.chdir(caseroot)

    casebuild            = case.get_value("CASEBUILD")
    caseroot             = case.get_value("CASEROOT")
    srcroot              = case.get_value("SRCROOT")
    din_loc_root         = case.get_value("DIN_LOC_ROOT")
    ninst_rof            = case.get_value("NINST_ROF")
    rof_grid             = case.get_value("ROF_GRID")
    mosart_bldnml_opts   = case.get_value("MOSART_BLDNML_OPTS")
    mosart_namelist_opts = case.get_value("MOSART_NAMELIST_OPTS")
    rundir               = case.get_value("RUNDIR")
    run_type             = case.get_value("RUN_TYPE")
    run_refcase          = case.get_value("RUN_REFCASE")
    run_refdate          = case.get_value("RUN_REFDATE")
    run_reftod           = case.get_value("RUN_REFTOD")
    scriptsroot          = case.get_value("SCRIPTSROOT")
    
    rofconf_dir = os.path.join(casebuild, "mosartconf")
    
    compset = case.get_value("COMPSET") 

    if not os.path.isdir(rofconf_dir): os.mkdir(rofconf_dir)

    #--------------------------------------------------------------------
    # Verify rof grid is supported
    #--------------------------------------------------------------------

    rof_grid_supported = ("null", "r2", "r05", "r0125", "r01", "NLDAS", "ELM_USRDAT")
    expect(rof_grid in rof_grid_supported, "ROF_GRID '{}' is not supported in mosart. Choose from: null, r2, r05, r0125, r01, NLDAS, ELM_USRDAT".format(rof_grid))

    #--------------------------------------------------------------------
    # Invoke mosart build-namelist - output will go in $CASEBUILD/mosartconf
    #--------------------------------------------------------------------

    inst_string = ""
    for inst_counter in range(1, ninst_rof + 1):

        # -----------------------------------------------------
        # determine instance string
        # -----------------------------------------------------

        inst_string = ""
        if ninst_rof > 1:
            inst_string = "_{0:04d}".format(inst_counter)

            # If multi-instance case does not have restart file, use single-case restart
            # for each instance
            if not os.path.exists(os.path.join(rundir, "rpointer.rof{}".format(inst_string))) and \
                   os.path.exists(os.path.join(rundir, "rpointer.rof")):
                safe_copy(os.path.join(rundir, "rpointer.rof"),
                          os.path.join(rundir, "rpointer.rof{}".format(inst_string)))

        # -----------------------------------------------------
        # create mosartconf/cesm_namelist
        # -----------------------------------------------------

        if os.path.exists(os.path.join(casebuild, "mosart.input_data_list")):
            os.remove(os.path.join(casebuild, "mosart.input_data_list"))

        # The following is for backwards compatibility when runoff restart data was on clm restart files
        infile_text = ""
        if rof_grid != "null":

            fncheck = ""
            if run_type == 'hybrid' or run_type == "branch":

    	        # search for clm or mosart files with instance or not
                fncheck = "{}/{}.mosart{}.r.{}-{}.nc".format(rundir, run_refcase, inst_string, run_refdate, run_reftod)
                if not os.path.exists(fncheck):
                    fncheck = "{}/{}.mosart.r.{}-{}.nc".format(rundir, run_refcase, run_refdate, run_reftod)
                    if not os.path.exists(fncheck):
                        fncheck = "{}/{}.clm2{}.r.{}-{}.nc".format(rundir, run_refcase, inst_string, run_refdate, run_reftod)
                        if not os.path.exists(fncheck):
                            fncheck = "{}/{}.clm2.r.{}-{}.nc".format(rundir, run_refcase, run_refdate, run_reftod)
                            expect(os.path.exists(fncheck), "ERROR mosart.buildnml: could not find restart file for branch or hybrid start")

            if run_type == "hybrid": infile_text += "finidat_rtm = '{}'\n".format(fncheck)
            if run_type == "branch": infile_text += "nrevsn_rtm  = '{}'\n".format(fncheck)

        
        print("MOSART::buildnml compset ", compset)
        mosart_nml_use_case = case.get_value("MOSART_NML_USE_CASE")

        if(not mosart_nml_use_case == "UNSET"): 
            nml_defaults_list = get_namelist_defaults(srcroot) 
            use_case_dir = srcroot+'/components/mosart/bld/namelist_files/use_cases' 
            use_case = use_case_dir +'/'+mosart_nml_use_case+'.xml'
            use_case_infile_text =  parse_use_case(use_case, nml_defaults_list)
            infile_text += use_case_infile_text 
        else: 
            print("NML USE CASE is UNSET")

        #print("MOSART::buildnml final infile_text is:",infile_text)     
        create_namelist_infile(case,
                               "{}/user_nl_mosart{}".format(caseroot, inst_string),
                               "{}/cesm_namelist".format(rofconf_dir),
                               infile_text=infile_text)

        # -----------------------------------------------------
        # call build-namelist
        # -----------------------------------------------------

        sysmod  = os.path.join(srcroot, "components/mosart/bld/build-namelist")
        sysmod += " -infile {}/cesm_namelist".format(rofconf_dir)
        sysmod += " -caseroot {}".format(caseroot)
        sysmod += " -scriptsroot {}".format(scriptsroot)
        sysmod += ' -namelist " &mosartexp {} /" '.format(mosart_namelist_opts)
        sysmod += ' -inst_string "{}" {}'.format(inst_string, mosart_bldnml_opts)
        run_cmd_no_fail(sysmod, from_dir=rofconf_dir)

        # -----------------------------------------------------
        # move mosart_in to $RUNDIR
        # -----------------------------------------------------
        if os.path.exists(rundir):
            safe_copy(os.path.join(rofconf_dir, "mosart_in"), os.path.join(rundir, "mosart_in{}".format(inst_string)))

###############################################################################
def _main_func():
###############################################################################
    caseroot = parse_input(sys.argv)
    with Case(caseroot) as case:
        buildnml(case, caseroot, "mosart")

if __name__ == "__main__":
    _main_func()
